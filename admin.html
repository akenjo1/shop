<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* CSS Styles giữ nguyên như các phiên bản trước */
        body { font-family: 'Inter', sans-serif; background-color: #1f2937; color: #d1d5db; }
        .modal-bg { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem;} 
        .form-input, .form-select, .form-textarea { background-color: #374151; border: 1px solid #4b5563; color: white; border-radius: 0.5rem; padding: 0.75rem 1rem; width: 100%; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; text-align: center; cursor: pointer; transition: background-color 0.2s; display: inline-block; }
        .btn-primary { background-color: #4f46e5; color: white; } .btn-primary:hover { background-color: #4338ca; } .btn-primary:disabled { background-color: #374151; cursor: not-allowed; }
        .btn-secondary { background-color: #4b5563; color: white; } .btn-secondary:hover { background-color: #6b7280; }
        .btn-danger { background-color: #e11d48; color: white; } .btn-danger:hover { background-color: #be123c; }
        .nav-tab { cursor: pointer; padding: 0.75rem 1.5rem; border-bottom: 2px solid transparent; color: #9ca3af; font-weight: 500; }
        .nav-tab.active { color: #4f46e5; border-bottom-color: #4f46e5; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #initial-loading { position: fixed; inset: 0; background-color: #1f2937; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; padding: 1rem; }
        #init-error-message { margin-top: 1rem; text-align: center; word-break: break-word; color: #f87171; font-weight: bold; font-family: monospace; font-size: 0.9em; background-color: #374151; padding: 1rem; border-radius: 0.5rem; border: 1px solid #4b5563;} 
         #admin-login-view { display: none; } /* Mặc định ẩn đi */
         #admin-login-view.visible { display: flex; } /* Hiện ra khi cần */
         .hidden { display: none !important; }
    </style>
</head>
<body class="antialiased">

    <!-- Initial Loading Screen -->
    <div id="initial-loading">
        <div class="spinner"></div>
        <!-- Khu vực hiển thị lỗi khởi tạo -->
        <div id="init-error-message" class="mt-4 hidden"></div>
    </div>

    <!-- Admin Login View -->
    <div id="admin-login-view" class="items-center justify-center min-h-screen p-4 hidden"> <!-- Sửa: Thêm hidden -->
        <!-- Nội dung form đăng nhập đầy đủ -->
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-lg shadow-2xl">
            <h1 class="text-3xl font-bold text-white text-center mb-6">Đăng Nhập Quản Trị</h1>
            <div id="login-error-message" class="bg-red-500 text-white p-3 rounded mb-4 hidden"></div>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="admin-email" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block text-sm font-medium mb-2">Mật khẩu</label>
                    <input type="password" id="admin-password" class="form-input" required>
                </div>
                <button type="submit" id="admin-login-submit" class="btn btn-primary w-full"> 
                    <span class="btn-text">Đăng Nhập</span>
                    <span class="btn-loader hidden"><div class="spinner mx-auto" style="width: 20px; height: 20px; border-width: 2px;"></div></span>
                </button>
            </form>
        </div>
    </div>
    <!-- End Admin Login View -->

    <!-- Admin Main View -->
    <div id="admin-main-view" class="container mx-auto p-4 md:p-8 hidden">
       <!-- Phần giao diện admin (tabs, tables, modals) đầy đủ -->
         <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-white">Trang Quản Trị</h1>
            <button id="admin-logout-btn" class="btn btn-danger">Đăng Xuất</button>
        </header>
        <div class="border-b border-gray-700 mb-6">
            <nav class="flex space-x-4">
                <button id="tab-users" class="nav-tab active">Quản Lý Người Dùng</button>
                <button id="tab-products" class="nav-tab">Quản Lý Sản Phẩm</button>
            </nav>
        </div>
        <div id="content-users">
             <div class="mb-4">
                <input type="text" id="user-search" class="form-input w-full md:w-1/2" placeholder="Tìm kiếm theo email hoặc username...">
            </div>
            <div class="overflow-x-auto bg-gray-800 rounded-lg shadow">
                <table class="w-full text-left">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="p-4 font-semibold">Username</th>
                            <th class="p-4 font-semibold">Email</th>
                            <th class="p-4 font-semibold">Số Dư</th>
                            <th class="p-4 font-semibold">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody id="user-list">
                        <!-- User rows will be loaded here -->
                        <tr><td colspan="4" class="p-4 text-center"><div class="spinner mx-auto"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div id="content-products" class="hidden">
             <div class="text-right mb-4">
                <button id="add-product-btn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Thêm Sản Phẩm Mới
                </button>
            </div>
            <div class="overflow-x-auto bg-gray-800 rounded-lg shadow">
                <table class="w-full text-left">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="p-4 font-semibold">Sản Phẩm</th>
                            <th class="p-4 font-semibold">Giá</th>
                            <th class="p-4 font-semibold">Giới Hạn Mua</th>
                            <th class="p-4 font-semibold">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody id="product-list-admin">
                         <!-- Product rows will be loaded here -->
                         <tr><td colspan="4" class="p-4 text-center"><div class="spinner mx-auto"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- End Admin Main View -->

    <!-- Modals -->
     <!-- User Edit Modal -->
    <div id="user-edit-modal" class="modal-bg hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <h2 class="text-2xl font-bold text-white mb-6">Chỉnh Sửa Người Dùng</h2>
            <p class="text-lg text-white mb-4" id="user-edit-email"></p>
            <form id="user-edit-form">
                <div class="mb-4">
                    <label for="user-edit-username" class="block text-sm font-medium mb-2">Username</label>
                    <input type="text" id="user-edit-username" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="user-edit-balance" class="block text-sm font-medium mb-2">Số Dư Hiện Tại</label>
                    <input type="number" id="user-edit-balance" class="form-input" disabled>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg mb-6">
                    <h3 class="font-semibold text-white mb-2">Điều Chỉnh Số Dư (Thủ Công)</h3>
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="user-edit-amount" class="block text-xs font-medium mb-1">Số tiền</label>
                            <input type="number" id="user-edit-amount" class="form-input" placeholder="ví dụ: 50000 hoặc -10000">
                        </div>
                        <button type="button" id="user-adjust-balance-btn" class="btn btn-primary self-end">Cập Nhật</button>
                    </div>
                </div>
                <div class="flex justify-between items-center space-x-4">
                    <div><button type="button" id="user-delete-btn" class="btn btn-danger">Xóa Người Dùng</button></div>
                    <div class="flex space-x-4">
                        <button type="button" id="user-edit-cancel" class="btn btn-secondary">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu Thay Đổi</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- Product Edit Modal -->
     <div id="product-edit-modal" class="modal-bg hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 overflow-y-auto max-h-screen">
            <h2 id="product-modal-title" class="text-2xl font-bold text-white mb-6">Thêm/Sửa Sản Phẩm</h2>
            <form id="product-edit-form">
                <input type="hidden" id="product-edit-id">
                <div class="mb-4">
                    <label for="product-edit-name" class="block text-sm font-medium mb-2">Tên Sản Phẩm</label>
                    <input type="text" id="product-edit-name" class="form-input" required>
                </div>
                <div class="mb-4">
                    <label for="product-edit-description" class="block text-sm font-medium mb-2">Mô Tả</label>
                    <textarea id="product-edit-description" class="form-textarea" rows="3"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="product-edit-price" class="block text-sm font-medium mb-2">Giá (VND)</label>
                        <input type="number" id="product-edit-price" class="form-input" required min="0">
                    </div>
                    <div>
                        <label for="product-edit-image-url" class="block text-sm font-medium mb-2">Link Ảnh</label>
                        <input type="text" id="product-edit-image-url" class="form-input">
                    </div>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg mb-6">
                    <h3 class="font-semibold text-white mb-4">Giới Hạn Mua</h3>
                    <div class="mb-4">
                        <label for="product-edit-limit-type" class="block text-sm font-medium mb-2">Loại Giới Hạn</label>
                        <select id="product-edit-limit-type" class="form-select">
                            <option value="none">Không giới hạn</option>
                            <option value="global">Giới hạn số lượng (Tất cả tài khoản)</option>
                            <option value="restricted">Chỉ cho phép người dùng cụ thể</option>
                        </select>
                    </div>
                    <div id="global-stock-field" class="mb-4 hidden">
                        <label for="product-edit-global-stock" class="block text-sm font-medium mb-2">Tổng số lượng bán</label>
                        <input type="number" id="product-edit-global-stock" class="form-input" min="0" value="0">
                    </div>
                    <div id="restricted-users-field" class="mb-4 hidden">
                        <label for="product-edit-allowed-users" class="block text-sm font-medium mb-2">Danh sách Email được mua (cách nhau bằng dấu phẩy)</label>
                        <textarea id="product-edit-allowed-users" class="form-textarea" rows="3" placeholder="user1@gmail.com, user2@gmail.com"></textarea>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <div><button type="button" id="product-delete-btn" class="btn btn-danger">Xóa Sản Phẩm</button></div>
                    <div class="flex space-x-4">
                        <button type="button" id="product-edit-cancel" class="btn btn-secondary">Hủy</button>
                        <button type="submit" class="btn btn-primary">Lưu Sản Phẩm</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Alert Toast -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 z-[100] bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 transition-all duration-300 -translate-y-10"> <!-- Tăng z-index -->
        <span id="toast-message"></span>
    </div>

    <script>
        // =============================================================
        // === KEY SUPABASE CỦA BẠN ĐÃ ĐƯỢC DÁN VÀO ĐÂY ===
        // =============================================================
        const SUPABASE_URL = 'https://okzaxfrazdowplynvpps.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9remF4ZnJhemRvd3BseW52cHBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDYzMTUsImV4cCI6MjA3Njc4MjMxNX0.rMKUCMnkNg3uldS7SAwR-o-fCFdUiDBvq_51iHERjsQ';
        // =============================================================

        // --- Utility Functions --- (Giữ nguyên)
        const $ = (selector) => document.querySelector(selector);
        const show = (el) => { 
            if(el) {
                el.classList.remove('hidden'); 
                if (el.id === 'admin-login-view') el.classList.add('flex'); 
            }
        };
        const hide = (el) => { 
            if(el) {
                el.classList.add('hidden'); 
                if (el.id === 'admin-login-view') el.classList.remove('flex'); 
            }
         };
        const enable = (btn) => { /* ... */ };
        const disable = (btn) => { /* ... */ };
        const showToast = (message, isError = false) => { /* ... */ };
        const formatCurrency = (amount) => { /* ... */ };

        // --- App State --- (Giữ nguyên)
        let appState = { 
            supabase: null,
            user: null,
            currentUserEdit: null,
            currentProductEdit: null,
         };

        // --- Hàm hiển thị lỗi khởi tạo ---
        function showInitError(message, details = '') { /* ... */ }
         
        // --- Admin Auth Service --- (v11 - Logic init đã được kiểm tra)
        const adminAuth = {
            supabaseInitialized: false, 

            async init() {
                try {
                    console.log("Admin Init V11 Final: Starting..."); 

                    if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL' || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                        throw new Error("Chưa cấu hình Supabase URL/Key.");
                    }
                    console.log("Admin Init V11 Final: Config OK.");

                    try {
                        appState.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        this.supabaseInitialized = true; 
                        console.log("Admin Init V11 Final: Supabase client created.");
                    } catch (clientError) {
                         throw new Error(`Lỗi tạo Supabase client: ${clientError.message}.`);
                    }
                    
                    console.log("Admin Init V11 Final: Getting session ONCE...");
                    const { data: { session }, error: sessionError } = await appState.supabase.auth.getSession();
                    console.log("Admin Init V11 Final: getSession result", session ? session.user.email : 'No session', sessionError);

                    if (sessionError) {
                        throw new Error(`Lỗi getSession ban đầu: ${sessionError.message}.`);
                    }

                    // Xử lý session ban đầu
                    if (session) {
                        console.log("Admin Init V11 Final: Session found. Checking admin status...");
                        try {
                            await this.checkAdmin(session.user); 
                        } catch (checkAdminError) {
                             console.error("Error during initial checkAdmin:", checkAdminError);
                        }
                    } else {
                        console.log("Admin Init V11 Final: No session found. Showing login screen.");
                        this.showLogin(); 
                    }
                    
                    const errorDiv = $('#init-error-message');
                    if (!errorDiv || errorDiv.classList.contains('hidden')) { 
                       hide($('#initial-loading')); 
                    }


                    // Gắn listener cho các thay đổi sau này
                    appState.supabase.auth.onAuthStateChange(async (event, currentSession) => {
                        console.log("Auth State Change V11 Final:", event, currentSession ? currentSession.user.email : 'No session'); 
                        if (event === 'SIGNED_OUT') {
                            this.showLogin();
                        } else if (event === 'SIGNED_IN') {
                            if(currentSession) {
                                try {
                                    await this.checkAdmin(currentSession.user);
                                } catch (listenerCheckError) {
                                     console.error("Error during listener checkAdmin:", listenerCheckError);
                                }
                            }
                        }
                    });
                     console.log("Admin Init V11 Final: Auth listener attached for future changes.");


                } catch (initError) {
                    showInitError(initError.message); 
                } 
            },

            // checkAdmin, login, logout, showLogin, showAdminPanel giữ nguyên như v5
             async checkAdmin(user) { /* ... logic như v5 ... */ },
             async login(email, password) { /* ... logic như v5 ... */ },
             async logout() { /* ... logic như v5 ... */ },
             showLogin(errorMessage = null) { /* ... logic như v5 ... */ },
             showAdminPanel() { /* ... logic như v5 ... */ }
        };

        // --- Admin User Management --- (Phần còn lại giữ nguyên)
        const adminUsers = { 
            async fetch(searchTerm = '') {/*...*/},
            render(users) {/*...*/},
            openEditModal(user) {/*...*/},
            async saveUser() {/*...*/},
            async adjustBalance() {/*...*/},
            async deleteUser() {/*...*/}
         };
        // --- Admin Product Management --- (Phần còn lại giữ nguyên)
        const adminProducts = { 
            async fetch() {/*...*/},
            render(products) {/*...*/},
            openEditModal(product = null) {/*...*/},
            toggleLimitFields() {/*...*/},
            async saveProduct() {/*...*/},
            async deleteProduct() {/*...*/}
        };
        // --- Event Listeners --- (Phần còn lại giữ nguyên)
        function addAdminListeners() { 
            /* ... (Gắn listener cho login, logout, tabs, modals...) ... */ 
         }

        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Admin page loaded. Initializing auth V11 Final..."); 
            try {
                adminAuth.init(); 
                addAdminListeners(); 
            } catch (syncInitError) {
                 showInitError(`Lỗi JavaScript cơ bản: ${syncInitError.message}`);
            }
        });
    </script>
</body>
</html>


